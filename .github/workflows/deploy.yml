name: Build & Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================
  # 1Ô∏è‚É£ Build & Test
  # ============================================================
  build-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: vodichron_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npm run typecheck

      - name: Lint code
        run: npm run lint

      - name: Build application
        run: npm run build:clean

      - name: Run tests
        run: npm run test
        env:
          DB_HOST: localhost
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: vodichron_test

  # ============================================================
  # 2Ô∏è‚É£ Deploy to Production (Main Branch)
  # ============================================================
  deploy-production:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: üîê Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "üîê Connected to VPS"
            cd /var/www/vodichron/vodichron-backend || { echo "‚ùå Folder not found"; exit 1; }

            echo "üì¶ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "üß© Ensuring correct permissions..."
            sudo chown -R $USER:$USER /var/www/vodichron/vodichron-backend

            echo "üì¶ Installing dependencies..."
            if [ -d "node_modules" ]; then
              echo "üßπ Removing existing node_modules..."
              rm -rf node_modules
            fi

            npm ci --production || npm install --production
            if [ $? -ne 0 ]; then
              echo "‚ùå npm install failed. Exiting..."
              exit 1
            fi

            echo "‚öôÔ∏è Building production..."
            npm run build:clean

            echo "üöÄ Restarting PM2..."
            pm2 restart vodichron-backend || pm2 start dist/server.js --name "vodichron-backend" --interpreter node -- --max-old-space-size=4096

            echo "‚úÖ Deployment complete!"

      - name: üîç Verify Health Endpoint
        continue-on-error: true
        run: |
          echo "‚è≥ Waiting for app to boot fully..."
          sleep 20

          MAX_RETRIES=9
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "üå°Ô∏è Health check attempt $i/$MAX_RETRIES..."

            HEALTH_CHECK=$(curl -sk -o /dev/null -w "%{http_code}" https://${{ secrets.PROD_DOMAIN }}/health 2>/dev/null || \
                           curl -sk -o /dev/null -w "%{http_code}" http://${{ secrets.PROD_DOMAIN }}/health 2>/dev/null || echo "000")

            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "‚úÖ Health check passed for ${{ secrets.PROD_DOMAIN }}/health"
              exit 0
            elif [ "$HEALTH_CHECK" = "503" ]; then
              echo "‚ö†Ô∏è Server returned 503 (still starting up)..."
            elif [ "$HEALTH_CHECK" = "000" ]; then
              echo "‚ùå Could not connect to domain (timeout or DNS issue)."
            else
              echo "‚ùå Health check failed (status: $HEALTH_CHECK)"
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "üîÅ Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "üö® Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: üìú Deployment Summary
        if: always()
        run: |
          echo "--------------------------------------------"
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Production Deployment Successful"
            echo "üåç Domain: https://${{ secrets.PROD_DOMAIN }}"
            echo "üì¶ Branch: main"
            echo "üßë‚Äçüíª Author: ${{ github.actor }}"
            echo "üî¢ Commit: ${{ github.sha }}"
          else
            echo "‚ùå Production Deployment Failed"
            echo "üîó Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          echo "--------------------------------------------"

  # ============================================================
  # 3Ô∏è‚É£ Deploy to Staging (Develop Branch)
  # ============================================================
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: üîê Deploy to Staging Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          script: |
            echo "üîê Connected to Staging VPS"
            cd /var/www/vodichron-backend-staging || { echo "‚ùå Folder not found"; exit 1; }

            echo "üì¶ Pulling latest code..."
            git fetch origin develop
            git reset --hard origin/develop

            echo "üß© Ensuring correct permissions..."
            sudo chown -R $USER:$USER /var/www/vodichron-backend-staging

            echo "üì¶ Installing dependencies..."
            if [ -d "node_modules" ]; then
              echo "üßπ Removing existing node_modules..."
              rm -rf node_modules
            fi

            npm ci --production || npm install --production
            if [ $? -ne 0 ]; then
              echo "‚ùå npm install failed. Exiting..."
              exit 1
            fi

            echo "‚öôÔ∏è Building staging build..."
            npm run build:clean

            echo "üöÄ Restarting PM2..."
            pm2 restart vodichron-backend-staging || pm2 start dist/server.js --name "vodichron-backend-staging" --interpreter node -- --max-old-space-size=4096

            echo "‚úÖ Staging deployment complete!"

      - name: üîç Verify Staging Health Endpoint
        continue-on-error: true
        run: |
          echo "‚è≥ Waiting for staging app to boot..."
          sleep 20

          MAX_RETRIES=9
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "üå°Ô∏è Health check attempt $i/$MAX_RETRIES..."

            HEALTH_CHECK=$(curl -sk -o /dev/null -w "%{http_code}" https://${{ secrets.STAGING_DOMAIN }}/health 2>/dev/null || \
                           curl -sk -o /dev/null -w "%{http_code}" http://${{ secrets.STAGING_DOMAIN }}/health 2>/dev/null || echo "000")

            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "‚úÖ Staging health check passed"
              exit 0
            elif [ "$HEALTH_CHECK" = "503" ]; then
              echo "‚ö†Ô∏è Staging server still starting..."
            else
              echo "‚ùå Staging health check failed (status: $HEALTH_CHECK)"
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "üîÅ Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "üö® Staging health check failed after retries"
          exit 1
