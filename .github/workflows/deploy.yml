name: Build & Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================
  # 1ï¸âƒ£ Build & Test
  # ============================================================
  build-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: vodichron_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npm run typecheck

      - name: Lint code
        run: npm run lint

      - name: Build application
        run: npm run build:clean

      - name: Run tests
        run: npm run test
        env:
          DB_HOST: localhost
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: vodichron_test

  # ============================================================
  # 2ï¸âƒ£ Deploy to Production (Main Branch)
  # ============================================================
  deploy-production:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "ğŸ” Connected to VPS"
            cd /var/www/vodichron/vodichron-backend || { echo "âŒ Folder not found"; exit 1; }

            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ§© Installing dependencies..."
            npm ci --production

            echo "âš™ï¸ Building production..."
            npm run build:clean

            echo "ğŸš€ Restarting PM2..."
            pm2 restart vodichron-backend || pm2 start dist/server.js --name "vodichron-backend" --interpreter node -- --max-old-space-size=4096

            echo "âœ… Deployment complete!"

      - name: ğŸ” Verify Health Endpoint
        continue-on-error: true
        run: |
          echo "â³ Waiting for app to start..."
          sleep 15
          
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ğŸŒ¡ï¸ Health check attempt $i/$MAX_RETRIES..."
            
            HEALTH_CHECK=$(curl -sk -o /dev/null -w "%{http_code}" https://${{ secrets.PROD_DOMAIN }}/health 2>/dev/null || \
                           curl -sk -o /dev/null -w "%{http_code}" http://${{ secrets.PROD_DOMAIN }}/health 2>/dev/null || echo "000")
            
            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "âœ… Health check passed for ${{ secrets.PROD_DOMAIN }}/health"
              exit 0
            fi
            
            echo "âŒ Health check failed (status: $HEALTH_CHECK)"
            if [ $i -lt $MAX_RETRIES ]; then
              echo "ğŸ” Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "ğŸš¨ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: ğŸ“œ Deployment Summary
        if: always()
        run: |
          echo "--------------------------------------------"
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Production Deployment Successful"
            echo "ğŸŒ Domain: https://${{ secrets.PROD_DOMAIN }}"
            echo "ğŸ“¦ Branch: main"
            echo "ğŸ§‘â€ğŸ’» Author: ${{ github.actor }}"
            echo "ğŸ”¢ Commit: ${{ github.sha }}"
          else
            echo "âŒ Production Deployment Failed"
            echo "ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          echo "--------------------------------------------"

  # ============================================================
  # 3ï¸âƒ£ Deploy to Staging (Develop Branch)
  # ============================================================
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Deploy to Staging Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          script: |
            echo "ğŸ” Connected to Staging VPS"
            cd /var/www/vodichron-backend-staging || { echo "âŒ Folder not found"; exit 1; }

            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin develop
            git reset --hard origin/develop

            echo "ğŸ§© Installing dependencies..."
            npm ci --production

            echo "âš™ï¸ Building staging build..."
            npm run build:clean

            echo "ğŸš€ Restarting PM2..."
            pm2 restart vodichron-backend-staging || pm2 start dist/server.js --name "vodichron-backend-staging" --interpreter node -- --max-old-space-size=4096

            echo "âœ… Staging deployment complete!"

      - name: ğŸ” Verify Staging Health Endpoint
        continue-on-error: true
        run: |
          echo "â³ Waiting for staging app to start..."
          sleep 15

          for i in $(seq 1 5); do
            echo "ğŸŒ¡ï¸ Staging health check attempt $i/5..."
            
            HEALTH_CHECK=$(curl -sk -o /dev/null -w "%{http_code}" https://${{ secrets.STAGING_DOMAIN }}/health 2>/dev/null || \
                           curl -sk -o /dev/null -w "%{http_code}" http://${{ secrets.STAGING_DOMAIN }}/health 2>/dev/null || echo "000")

            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "âœ… Staging health check passed"
              exit 0
            fi

            echo "âŒ Staging health check failed (status: $HEALTH_CHECK)"
            [ $i -lt 5 ] && echo "ğŸ” Retrying..." && sleep 10
          done

          echo "ğŸš¨ Staging health check failed after retries"
          exit 1
